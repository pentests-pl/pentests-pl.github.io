---
layout: post
title: Linux - spawn bash with id elevation
date: '2014-05-28T11:57:00.000+02:00'
author: marcing
tags:
- privilege elevation
- spawning bash
- linux remote shell
- python spawn
- pentests
modified_time: '2014-05-28T11:57:45.629+02:00'
blogger_id: tag:blogger.com,1999:blog-252370192815002266.post-3592274681982887960
blogger_orig_url: https://blog.pentests.pl/2014/05/linux-spawn-bash-with-id-elevation.html
excerpt: Python one-liner for spawning elevated bash shell.
---

Sometimes during penetration test you can end in situation like that:
<div class="cssterm">
$ id
uid=1000(&lt;user1&gt;) gid=1000(&lt;group1&gt;) euid=1001(&lt;user2&gt;) groups=1001(&lt;group2&gt;),1000(&lt;group1&gt;)
$ whoami
&lt;user2&gt;
</div>

Mostly it will be remote reverse shells and going:

> $ /bin/bash

is not an option xD

There is a nice way to escape from that typing:

> $ python -c 'import pty;pty.spawn("/bin/bash")'

it works nice and makes your life easier... but in situation like that one you will
end with something like that:

<div class="cssterm">
$ whoami
&lt;user2&gt;
$ id
uid=1000(&lt;user1&gt;) gid=1000(&lt;group1&gt;) euid=1001(&lt;user2&gt;) groups=1001(&lt;group2&gt;),1000(&lt;group1&gt;)
$ python -c 'import pty;pty.spawn("/bin/bash")'
bash-4.2$ whoami
whoami
&lt;user1&gt;
bash-4.2$ id
id
uid=1000(&lt;user1&gt;) gid=1000(&lt;group1&gt;) groups=1000(&lt;group1&gt;)
bash-4.2$
</div>

As you can see we went back to user1 loosing privileges from user2. When I had to
deal with problem like that one I found this solution:

```c
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

int main() {
    setreuid(1001,1001);
    setegid(1001);
    system("/bin/sh");
    return 0;
}
```

Unfortunately, most of the times you will have to compile binary somewhere else and
then copy it to target, but in return you get this:

<div class="cssterm">
$ whoami
&lt;user2&gt;
$ id
uid=1000(&lt;user1&gt;) gid=1000(&lt;group1&gt;) euid=1001(&lt;user2&gt;) groups=1001(&lt;group2&gt;),1000(&lt;group1&gt;)
$ ./id_ele
whoami
&lt;user2&gt;
id
uid=1001(&lt;user2&gt;) gid=1000(&lt;user1&gt;) groups=1001(&lt;group2&gt;),1000(&lt;group1&gt;)
python -c 'import pty;pty.spawn("/bin/bash")'
&lt;user2&gt;@host:/
</div>

It is working and you are now user2. That solution is nice and it helped me a lot
but after while I&nbsp;sat and asked myself: "Why not use some Python magic?".
I'm not very familiar with Python but I've found easily method I was looking for:

```
os.setresuid(ruid, euid, suid)

Set the current processâ€™s real, effective, and saved user ids.
Availability: Unix.
New in version 2.7.
```

So now shell-spawning command will look like that:

> python -c 'import os,pty; os.setresuid(new_id,new_id,new_id); pty.spawn("/bin/bash")'

Let's give it a try:

<div class="cssterm">
$ whoami
&lt;user2&gt;
$ id
uid=1000(&lt;user1&gt;) gid=1000(&lt;group1&gt;) euid=1001(&lt;user2&gt;) groups=1001(&lt;group2&gt;),1000(&lt;group1&gt;)
$ python -c 'import os,pty; os.setresuid(1001,1001,1001); pty.spawn("/bin/bash")'
&lt;user2&gt;@host:/$ whoami
whoami
&lt;user2&gt;
&lt;user2&gt;@host:/$ id
id
uid=1001(&lt;user2&gt;) gid=1000(&lt;user1&gt;) groups=1001(&lt;group2&gt;),1000(&lt;group1&gt;)
&lt;user2&gt;@host:/$
</div>

Mission accomplished! No compiling, fast, easy, working. Enjoy!
